<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recovery Tracker – Full Version Enhanced</title>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#020617;color:#e5e7eb;padding:1rem;display:flex;justify-content:center}
.app{max-width:1000px;width:100%}
h1{text-align:center;margin-bottom:1rem}

.card{background:#111827;border-radius:.75rem;padding:1rem;margin-bottom:.75rem}
.row{display:flex;gap:.5rem;justify-content:space-between;align-items:center;flex-wrap:wrap}

button{border:none;border-radius:.6rem;padding:.45rem .8rem;font-weight:600;cursor:pointer}
.secondary{background:#1f2937;color:#e5e7eb}
.danger{background:#dc2626;color:white}
.save{background:#2563eb;color:white}
.urge{background:#22c55e;color:#052e16}

.timer{color:#22c55e;font-weight:bold;font-size:1.1rem}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem}
.stat{background:#020617;padding:.6rem;border-radius:.5rem;text-align:center}
.stat b{display:block;font-size:1.1rem}

canvas{background:#020617;border-radius:.5rem}

input,textarea{width:100%;background:#020617;color:#e5e7eb;border:1px solid #1f2937;border-radius:.5rem;padding:.4rem}
textarea{min-height:60px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;padding:1rem}
.modal-content{background:#111827;border-radius:.75rem;padding:1rem;max-width:800px;width:100%;max-height:90vh;overflow-y:auto}

.slider-row{display:flex;align-items:center;gap:.5rem}
.slider-row span{min-width:30px;text-align:right}

.quote{text-align:center;color:#94a3b8;font-style:italic}
</style>
</head>

<body>
<div class="app">
<h1>Recovery Tracker</h1>

<!-- TIMER -->
<div class="card row">
  <div>
    <div style="font-size:.75rem;color:#94a3b8">Since last relapse</div>
    <div class="timer" id="timer"></div>
  </div>
  <div>
    <button class="danger" onclick="relapse()">Relapse</button>
    <button class="secondary" onclick="openModal('manualRelapseModal')">Set manually</button>
  </div>
</div>

<!-- EPOCHS -->
<div class="card">
  <h3>Progress Epochs</h3>
  <p id="epochMessage"></p>
  <div class="stat-grid" id="epochStats"></div>
</div>

<!-- STATISTICS -->
<div class="card">
  <h3>Statistics</h3>
  <div class="stat-grid">
    <div class="stat"><b id="discipline">0</b>Discipline</div>
    <div class="stat"><b id="avgUrges">0</b>Avg Urges</div>
    <div class="stat"><b id="riskTrend">0</b>Risk Trend</div>
    <div class="stat"><b id="consistency">0</b>Consistency (days/week)</div>
  </div>
</div>

<!-- GRAPH -->
<div class="card">
  <div class="row">
    <h3 id="graphTitle">Urges, Risk & Relapses – Full year</h3>
  </div>
  <canvas id="graph" width="900" height="250"></canvas>
</div>

<!-- URGES -->
<div class="card row">
  <div id="urgeCount">0 urges today</div>
  <div>
    <button class="secondary" onclick="changeUrge(-1)">−</button>
    <button class="urge" onclick="changeUrge(1)">+</button>
  </div>
</div>

<!-- ACTIONS -->
<div class="card row">
  <button class="secondary" onclick="openReflection()">Daily reflection</button>
  <button class="secondary" onclick="openHistory()">Logs</button>
  <button class="secondary" onclick="openRiskAssessment()">Risk Assessment</button>
  <button class="danger" onclick="openModal('sosModal')">SOS</button>
  <button class="secondary" onclick="exportJSON()">Export JSON</button>
  <button class="secondary" onclick="exportExcel()">Export Excel</button>
  <input type="file" id="importFile" accept=".json,.xlsx" style="display:none">
  <button class="secondary" onclick="document.getElementById('importFile').click()">Import JSON / Excel</button>
</div>

<!-- MOTIVATION -->
<div class="card">
  <div class="quote" id="quote"></div>
  <div style="text-align:center;margin-top:.5rem">
    <button class="secondary" onclick="newQuote()">More motivation</button>
  </div>
</div>

<!-- MODALS -->
<!-- Reflection -->
<div class="modal" id="reflectionModal">
  <div class="modal-content">
    <h3>Daily Reflection</h3>
    <label>Feelings</label>
    <textarea id="feelings"></textarea>
    <label>Behaviors / triggers</label>
    <textarea id="behavior"></textarea>
    <div class="row">
      <button class="save" onclick="saveReflection()">Save</button>
      <button class="secondary" onclick="closeModal('reflectionModal')">Close</button>
    </div>
  </div>
</div>

<!-- History -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>Logs</h3>
    <div id="historyList"></div>
    <button class="secondary" onclick="closeModal('historyModal')">Close</button>
  </div>
</div>

<!-- Risk -->
<div class="modal" id="riskModal">
  <div class="modal-content">
    <h3>Daily Risk Assessment</h3>

    <div class="slider-row">
      <label>Mental</label>
      <input type="range" id="mentalState" min="0" max="100" oninput="mentalVal.textContent=this.value">
      <span id="mentalVal">50</span>
    </div>

    <div class="slider-row">
      <label>Desire</label>
      <input type="range" id="desire" min="0" max="100" oninput="desireVal.textContent=this.value">
      <span id="desireVal">50</span>
    </div>

    <div class="slider-row">
      <label>Physical</label>
      <input type="range" id="physical" min="0" max="100" oninput="physicalVal.textContent=this.value">
      <span id="physicalVal">50</span>
    </div>

    <label><input type="checkbox" id="nocturnal"> Nocturnal emission</label><br>
    <label><input type="checkbox" id="alone"> Alone most of day</label><br>
    <label><input type="checkbox" id="sexualContent"> Sexual content</label>

    <div class="row">
      <button class="save" onclick="saveRisk()">Save & Evaluate</button>
      <button class="secondary" onclick="closeModal('riskModal')">Close</button>
    </div>

    <p id="riskScoreDisplay"></p>
  </div>
</div>

<!-- SOS -->
<div class="modal" id="sosModal">
  <div class="modal-content">
    <h3>SOS</h3>
    <p>Pause. Breathe 4–4–6. Urges peak and fall.</p>
    <button class="secondary" onclick="closeModal('sosModal')">Close</button>
  </div>
</div>

<!-- Manual Relapse -->
<div class="modal" id="manualRelapseModal">
  <div class="modal-content">
    <h3>Set last relapse</h3>
    <input type="datetime-local" id="manualRelapseInput">
    <div class="row">
      <button class="save" onclick="setManualRelapse()">Save</button>
      <button class="secondary" onclick="closeModal('manualRelapseModal')">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
/* ===================== CORE DATA ===================== */
const STORAGE="recoveryEnhanced";
let graphRange=14;

const epochs=[
  {h:1,msg:"First hour completed."},
  {h:6,msg:"First resistance passed."},
  {h:12,msg:"Pressure decreasing."},
  {h:24,msg:"One full day complete."},
  {h:168,msg:"One week done, now the hardest urge, be ready."},
  {h:336,msg:"Two weeks done, passed the worst urge."},
  {h:720,msg:"One month = great foundation."},
  {h:1440,msg:"Two months done."},
  {h:2160,msg:"Three months rewiring process."},
  {h:4320,msg:"Six months resilience getting unstoppable."},
  {h:6480,msg:"Nine months mastery."},
  {h:8760,msg:"One year identity shift."}
];

const quotes=[
  "Urges pass whether you act or not.",
  "Discomfort is the price of freedom.",
  "Delay is victory.",
  "You are not the urge.",
  "Discipline compounds quietly.",
  "This moment will end.",
  "You are more than fleeting gratification. Break free from the trap of unrealistic expectations and redefine your self-image based on who you truly are—not what you consume.",
  "Replace shallow, virtual experiences with meaningful, face-to-face relationships. With your attention and emotions no longer scattered, you can cultivate genuine intimacy and trust with others.",
  "Without the distraction of explicit content, your mind is free to dream bigger and accomplish more. Imagine the projects you could start, the books you could read, and the skills you could master with this reclaimed time.",
  "Explicit content often leaves us feeling restless or anxious. By saying no to it, you create space for peace and self-control, building a stronger, healthier mindset.",
  "Sin can feel like a heavy chain, but Jesus came to set you free. When you surrender your struggles to Him, His grace transforms you, empowering you to walk in purity and strength. Every choice to resist temptation is an act of worship and a declaration of your trust in Him.",
  "By overcoming this struggle, your testimony becomes a beacon of hope for others. Show the world that Gods strength is made perfect in our weakness and that His love has the power to transform lives.",
  "God created you for more than temporary gratification. Explicit content distorts the beauty of His design for love, intimacy, and relationships. By turning away from it, you honor His blueprint for your life and rediscover your true identity in Christ",
  "Love thrives on trust and respect. Consuming explicit content creates a gap between you and your partner, often leading to feelings of inadequacy or mistrust. By turning away from it, you show your partner that they are enough—that you choose them, wholly and completely, every day",
  "Explicit content distorts Gods beautiful design for intimacy, reducing it to a selfish act rather than a sacred bond. When you let it go, you create space for real, God-honoring intimacy—one that is rooted in love, vulnerability, and mutual respect",
  "The use of explicit content can cause hurt and insecurity in a relationship, even if unspoken. By choosing to stop, you protect your partners heart from unnecessary wounds and reaffirm their worth in your eyes",
  "Your relationship is a testimony—to your partner, to others, and to future generations. Show the world what it looks like to love selflessly, to fight temptation for the sake of your partner, and to keep God at the center of your choices",
  "Your decision to walk in purity sets the tone for your relationship. It shows your partner that you are committed not just to them, but also to living a life that reflects Gods love and faithfulness. This kind of commitment creates a foundation for a relationship that endures lifes challenges",
  "Research has shown that explicit content can lead to feelings of anxiety, depression, and even addiction-like behaviors. Walking away allows your mind to reset, creating space for joy, calm, and clarity.",
  "Explicit content often leads to unhealthy comparisons that can damage your self-esteem or your view of your partner. By letting go, you free yourself from the toxic cycle of comparison and begin to see yourself and your partner through Gods loving, grace-filled perspective.",
  "Every time you choose to walk away from temptation, you strengthen your ability to resist it in other areas of life. This discipline spills over into your relationships, work, and spiritual walk, helping you become the strong, focused person God designed you to be."
];

/* ===================== HELPERS ===================== */
function load(){return JSON.parse(localStorage.getItem(STORAGE))||{lastRelapse:Date.now(),days:{}}}
function save(d){localStorage.setItem(STORAGE,JSON.stringify(d))}
function today(){return new Date().toISOString().slice(0,10)}

function openModal(id){document.getElementById(id).style.display="flex"}
function closeModal(id){document.getElementById(id).style.display="none"}

/* ===================== RELAPSE ===================== */
function relapse(){
  if(!confirm("Confirm relapse?"))return;
  const d=load();
  d.lastRelapse=Date.now();
  const t=today();
  d.days[t]=d.days[t]||{urges:0};
  d.days[t].relapse=true;
  save(d);
}

function setManualRelapse(){
  const v=manualRelapseInput.value;
  if(!v)return;
  const d=load();
  d.lastRelapse=new Date(v).getTime();
  const t=today();
  d.days[t]=d.days[t]||{urges:0};
  d.days[t].relapse=true;
  save(d);
  closeModal('manualRelapseModal');
}

/* ===================== URGES ===================== */
function changeUrge(delta){
  const d=load(),t=today();
  d.days[t]=d.days[t]||{urges:0};
  d.days[t].urges=Math.max(0,(d.days[t].urges||0)+delta);
  save(d);renderToday();
}

function renderToday(){
  const d=load().days[today()];
  urgeCount.textContent=d?`${d.urges||0} urges today`:"0 urges today";
}

/* ===================== REFLECTION ===================== */
function openReflection(){
  const d=load().days[today()]||{};
  feelings.value=d.feelings||"";
  behavior.value=d.behavior||"";
  openModal('reflectionModal');
}

function saveReflection(){
  const d=load(),t=today();
  d.days[t]=d.days[t]||{urges:0};
  d.days[t].feelings=feelings.value;
  d.days[t].behavior=behavior.value;
  save(d);closeModal('reflectionModal');
}

/* ===================== HISTORY ===================== */
function openHistory(){
  renderHistory();
  openModal('historyModal');
}

function renderHistory(){
  historyList.innerHTML="";
  const d=load().days;
  Object.keys(d).sort().reverse().forEach(day=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <b>${day}</b><br>
      Urges: ${d[day].urges||0}<br>
      Risk: ${d[day].riskScore??"-"}<br>
      ${d[day].feelings||""}<br>
      ${d[day].behavior||""}
      ${d[day].relapse?"<br><b>Relapse</b>":""}
      <br><button class="danger" onclick="deleteDay('${day}')">Delete</button>
    `;
    historyList.appendChild(c);
  });
}

function deleteDay(day){
  if(!confirm("Delete data for "+day+"?"))return;
  const d=load();
  delete d.days[day];
  save(d);
  renderHistory();
}

/* ===================== RISK ===================== */
function openRiskAssessment(){
  const d=load().days[today()]||{};
  mentalState.value=d.mentalState??50;
  desire.value=d.desire??50;
  physical.value=d.physical??50;
  mentalVal.textContent=mentalState.value;
  desireVal.textContent=desire.value;
  physicalVal.textContent=physical.value;
  nocturnal.checked=d.nocturnal||false;
  alone.checked=d.alone||false;
  sexualContent.checked=d.sexualContent||false;
  riskScoreDisplay.textContent="";
  openModal('riskModal');
}

function saveRisk(){
  const d=load(),t=today();
  d.days[t]=d.days[t]||{urges:0};
  Object.assign(d.days[t],{
    mentalState:+mentalState.value,
    desire:+desire.value,
    physical:+physical.value,
    nocturnal:nocturnal.checked,
    alone:alone.checked,
    sexualContent:sexualContent.checked
  });

  let score=(100-d.days[t].mentalState)*0.3
           +d.days[t].desire*0.4
           +(100-d.days[t].physical)*0.1;

  if(d.days[t].nocturnal)score+=10;
  if(d.days[t].alone)score+=10;
  if(d.days[t].sexualContent)score+=10;

  d.days[t].riskScore=Math.min(100,Math.round(score));
  save(d);
  riskScoreDisplay.textContent="Risk Score: "+d.days[t].riskScore;
}
/* ===================== STATS ===================== */
function renderStats(){
  const days=Object.values(load().days);
  if(!days.length)return;

  const avg=days.reduce((a,b)=>a+(b.urges||0),0)/days.length;
  avgUrges.textContent=avg.toFixed(1);
  discipline.textContent=Math.max(0,100-avg*8).toFixed(0);
  riskTrend.textContent=(days.at(-1)?.riskScore||0)-(days[0]?.riskScore||0);
  consistency.textContent=(days.length/7).toFixed(1);
}

/* ===================== EPOCHS ===================== */
function renderEpochs(hours){
  epochStats.innerHTML="";
  let msg="Stabilizing…";

  epochs.forEach(e=>{
    if(hours>=e.h)msg=e.msg;
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML=`<b>${hours>=e.h?"✓":"–"}</b>${e.h<24?e.h+"h":Math.round(e.h/24)+"d"}`;
    epochStats.appendChild(el);
  });

  epochMessage.textContent=msg;
}

/* ===================== GRAPH ===================== */
function toggleGraphRange(){
  graphRange=graphRange===14?365:14;
  graphTitle.textContent=
    graphRange===14
    ?"Urges, Risk & Relapses – Last 14 Days"
    :"Urges, Risk & Relapses – Full Year";
}

function renderGraph(){
  const ctx=graph.getContext("2d");
  ctx.clearRect(0,0,graph.width,graph.height);

  const data=Object.values(load().days).slice(-graphRange);

  data.forEach((d,i)=>{
    // Urges
    ctx.fillStyle="#22c55e";
    ctx.fillRect(i*6,250-(d.urges||0)*10,3,(d.urges||0)*10);

    // Risk
    ctx.fillStyle="#dc2626";
    ctx.fillRect(i*6+3,250-(d.riskScore||0)*2,3,(d.riskScore||0)*2);

    // Relapse marker
    if(d.relapse){
      ctx.fillStyle="#facc15";
      ctx.beginPath();
      ctx.arc(i*6+1.5,245,4,0,2*Math.PI);
      ctx.fill();
    }
  });
}

/* ===================== TIMER ===================== */
function update(){
  const d=load();
  const diff=Date.now()-d.lastRelapse;
  const s=Math.floor(diff/1000);

  timer.textContent=
    `${Math.floor(s/86400)}d ${Math.floor(s%86400/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s`;

  renderEpochs(diff/3600000);
  renderStats();
  renderGraph();
}

/* ===================== EXPORT JSON ===================== */
function exportJSON(){
  const data=JSON.stringify(load(),null,2);
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="recovery_data.json";
  a.click();
}

/* ===================== EXPORT EXCEL ===================== */
function exportExcel(){
  const d=load().days;
  const rows=Object.keys(d).map(date=>({date,...d[date]}));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Recovery");
  XLSX.writeFile(wb,"recovery_data.xlsx");
}

/* ===================== IMPORT HANDLER ===================== */
document.getElementById("importFile").addEventListener("change",importFileHandler);

function importFileHandler(e){
  const file=e.target.files[0];
  if(!file)return;

  if(file.name.endsWith(".json")){
    importJSON(file);
  }else if(file.name.endsWith(".xlsx")){
    importExcel(file);
  }else{
    alert("Unsupported file type");
  }
  e.target.value="";
}

/* ===================== IMPORT JSON ===================== */
function importJSON(file){
  const reader=new FileReader();
  reader.onload=evt=>{
    try{
      const imported=JSON.parse(evt.target.result);
      const current=load();
      Object.assign(current.days,imported.days||{});
      if(imported.lastRelapse)current.lastRelapse=imported.lastRelapse;
      save(current);
      update();renderToday();
      alert("JSON imported successfully");
    }catch{
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}

/* ===================== IMPORT EXCEL ===================== */
function importExcel(file){
  const reader=new FileReader();
  reader.onload=evt=>{
    const data=new Uint8Array(evt.target.result);
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws);

    if(!rows.length || !rows[0].date){
      alert("Invalid Excel format");
      return;
    }

    const current=load();

    rows.forEach(r=>{
      if(!r.date)return;
      current.days[r.date]={
        urges:+r.urges||0,
        riskScore:+r.riskScore||undefined,
        mentalState:+r.mentalState||undefined,
        desire:+r.desire||undefined,
        physical:+r.physical||undefined,
        nocturnal:!!r.nocturnal,
        alone:!!r.alone,
        sexualContent:!!r.sexualContent,
        feelings:r.feelings||"",
        behavior:r.behavior||"",
        relapse:!!r.relapse
      };
    });

    save(current);
    update();renderToday();
    alert("Excel imported successfully");
  };
  reader.readAsArrayBuffer(file);
}

/* ===================== QUOTES ===================== */
function newQuote(){
  quote.textContent=quotes[Math.floor(Math.random()*quotes.length)];
}

/* ===================== INIT ===================== */
setInterval(update,1000);
newQuote();
renderToday();
update();

</script>
</body>
</html>
